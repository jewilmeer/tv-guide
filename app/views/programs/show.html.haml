- if current_user.try(:trusted?)
  - content_for :head do
    = auto_discovery_link_tag :rss, :format => :rss

- page_title @program.name
- content_for(:bottom_js_domready) do
  :plain
    $('#check_update')
      .bind('ajax:beforeSend', function() {
        var $this = $(this);
        $this.html('Checking...');
      })
      .bind('ajax:failure', function() {
        var $this = $(this);
        $this.html( 'Update failed!' );
      })
      .bind('ajax:success', function(xhr,data,status) {
        var $this = $(this);
        if( data ) {
          $this.html('Updated, reloading')
          document.location.href = document.location.href;
        } else {
          $this.html('No update available');
        }
      })

%section
  .page-header
    %h1
      = @program.name
      %small
        = @program.status
      - if current_user.try(:trusted?)
        = link_to(tokened_program_path(:id => @program.id, :user_credentials => current_user.single_access_token, :format => :rss), :class => 'right-rss') do 
          = icon_tag('rss', :size => '24x24', :alt => 'RSS feed')
  %ul.tabs{:data => {:tabs => :tabs}}
    %li.active= link_to 'Season Overview', '#seasons'
    %li= link_to 'More information', '#more-info'
    / %li= link_to 'Options and other stuff', '#other'
  .row
    .span12
      - if @featured_image
        %img{:src => image_path(@featured_image, :format => :jpg), :width => 700, :height => 129}
      - else
        = image_tag( @program.banner_url, :size => '940x173') if @program.banner
    .span4
      %ul.unstyled
        %li
          - if @program.users.any?
            %abbr{:title => @program.users.map(&:login).to_sentence}= pluralize(@program.users.count, 'watcher')
          - else
            No watchers
        %li== Last updated #{distance_of_time_in_words_to_now(@program.tvdb_last_update)} ago
        %li= link_to 'Imdb page', "http://www.imdb.com/title/#{@program.imdb_id}"
        / %li= link_to 'View update list', program_updates_path(@program)
        - if current_user
          %li= link_to 'Check for updates', user_program_path(current_user, @program), :id => :check_update, :remote => true, :method => :put
          = render :partial => 'guide_control', :locals => {:program => @program}

.tab-content
  %section#seasons.active
    .page-header
      %h3 Seasons
    %ul.tabs{:data => {:tabs => :tabs}}
      - seasons_for_tab(@program).each do |season|
        %li{:class => (:active if @program.max_season_nr == season)}
          %a{:href => "#s#{season}"}== Season #{season} (#{@program.episodes.where('season_nr = ?', season).count})
      - if seasons_for_dropdown(@program).any?
        %li.dropdown{:data => {:dropdown => :dropdown}}
          %a.dropdown-toggle== Older seasons (#{seasons_for_dropdown(@program).length})
          %ul.dropdown-menu
            - seasons_for_dropdown(@program).each do |season|
              %li{:class => (:active if @program.max_season_nr == season)}
                %a{:href => "#s#{season}"}== Season #{season} (#{@program.episodes.where('season_nr = ?', season).count})
    .tab-content                  
      - @program.max_season_nr.downto(1) do |season|
        %div{:id => "s#{season}", :class => (:active if @program.max_season_nr == season)}
          %table.zebra-striped
            %thead
              %tr
                %th Title
                %th{:width => 150} Airdate
            %tbody
              = render :collection => @program.episodes.where('season_nr = ?', season).by_nr(:desc), :partial => 'episodes/episodes', :as => :episode

  %section#more-info
    .page-header
      %h3 More information
    %table
      %tr
        %th{:width => 100} Runtime
        %td= pluralize( @program.runtime, 'minute')
        %th{:width => 100} Genres
        %td= @program.genres.map(&:name).to_sentence
        %th{:width => 100} Network
        %td{:width => 150}= @program.network
      %tr
        %th Next episode
        %td
          - if episode = @program.episodes.next_airing.first
            = l episode.airs_at, :format => :long
          - else
            \-
        %th Thetvdb rating
        %td= @program.tvdb_rating || 'Not available'
        %th Content rating
        %td= @program.contentrating || 'Not available'
      - if @program.actors.any?
        %tr
          %th.top Actors
          %td{:colspan => 5}= @program.actors.to_sentence(:last_word_connector => ' and ')
      %tr
        %th.top Overview
        %td{:colspan => 5}= @program.overview
